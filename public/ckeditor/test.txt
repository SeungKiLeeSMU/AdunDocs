$(function() {
    $('#search_btn').click(function() {
        var url = $('#blog_url').val();
        if(!url) {
            alert('정확한 블로그 URL을 입력해주세요.');
        } else {
            new BlogHelper(url);
        }
    });
    var DAY = ['일', '월', '화', '수', '목', '금', '토'];
    String.prototype.format = function() {
        var formatted = this;
        for (var i = 0; i < arguments.length; i++) {
            var regexp = new RegExp('\\{'+i+'\\}', 'gi'),
                    str =  arguments[i] || '';
            formatted = formatted.replace(regexp, str);
        }
        return formatted;
    };

    function BlogHelper(url) {
        this.blogURL = url;
        if(url.indexOf('naver') > 0) {
            var b = url.indexOf('.');
            this.rssURL = url.slice(0, b) + '.rss' + url.slice(b) + ".xml";
            this.naver = true;
        } else if(url.indexOf('tistory') > 0){
            this.rssURL  = url + '/rss';
            this.tistory = true;

        } else {
            alert('티스토리, 네이버만 지원합니다.');
            location.reload();
        }
        this.init();
        this.getRSS();

    }
    BlogHelper.prototype.init = function() {
        this.naverFormat = "https://search.naver.com/search.naver" +
                "?where=post" +
                "&query={0}" +
                "&ie=utf8" +
                "&st=sim" +
                "&sm=tab_opt" +
                "&date_from=" +
                "&date_to=" +
                "&date_option=0" +
                "&srchby=title" +
                "&dup_remove={1}" +
                "&post_blogurl={2}" +
                "&post_blogurl_without=" +
                "&nso=so%3Ar%2Ca%3At%2Cp%3Aall" +
                "&mson=0";
        this.$frame = qq('#frame');
        this.$table = qq('#table');
        this.RSS = [];
        this.currentRSS = 0;
    };
    BlogHelper.prototype.getRSS = function() {
        var self = this;
        $.getFeed({
            url: self.rssURL,
            success: function(feed) {
                var items = feed.items;
                for(var i = 0, len = items.length; i < len; ++i) {
                    items[i]._id = "rss_" + i;
                    items[i].date = self.korDate(items[i].updated);
                    self.RSS.push(items[i]);
                }
                self.search(1);
            }
        });
    };
    BlogHelper.prototype.appendTable = function(item) {
        var $table = this.$table;
        setTimeout(function() {
            var str = "<tr id = '" + item._id+"'>";
            str += "<td >" + "<a href='"+ item.query + "' target='blank' >" +item.title +"</a></td>";
            str += "<td>" + item.date + "</td>";
            str += "<td>" + item.result +  "</td>";
            str += "</tr>";
            $table.append(str);
        },0);
    };
    BlogHelper.prototype.korDate = function(dateStr) {
        var d = new Date(dateStr);
        var month =  (d.getMonth()) + 1 < 10 ?  "0" + (d.getMonth() + 1) : d.getMonth() + 1;
        return month + '/' + d.getDate() + '(' + DAY[d.getDay()]+ ') ' + d.getHours() + ':' + d.getMinutes();
    };
    BlogHelper.prototype.search = function(similar) {
        // if similar == 1 then 유사문서 미포함.
        // if similar == 0 then 유사문서 포함.
        var self = this;
        var idx = this.currentRSS;
        if(this.RSS.length > 0 && idx < this.RSS.length) {
            var query = this.naverFormat.format(encodeURI(this.RSS[idx].title), similar, this.blogURL);
            self.RSS[idx].query = query;
            qq.ajax({
                url: query,
                success: function(data) {
                    var html = qq.parseHTML(data);
                    if(self.tistory)
                    {
                        var result = qq(html).find('a[href="'+ self.RSS[idx].link +'"]').length > 0 ? true : false;
                    }
                    if(self.naver)
                    {
                        var d = self.RSS[idx].link.lastIndexOf('/');
                        var e = self.RSS[idx].link.slice(d+1);
                        var j = self.blogURL + "?Redirect=Log&logNo=" + e;
                        var result = qq(html).find('a[href="'+ j +'"]').length > 0 ? true : false;
                    }
                    switch (similar) {
                        case 1 :
                            if (result) {
                                self.RSS[idx].result = '정상';
                                self.appendTable(self.RSS[idx]);
                                self.currentRSS++;
                                self.search(1);
                            } else {
                                self.search(0);
                            }
                            break;
                        case 0 :
                            if (result) {
                                self.RSS[idx].result = '유사문서';
                                self.appendTable(self.RSS[idx]);
                            } else {
                                self.RSS[idx].result = '누락';
                                self.appendTable(self.RSS[idx]);
                            }
                            self.currentRSS++;
                            self.search(1);
                            break;
                    }

                }
            });

        } else {
            console.dir(self.RSS);
            return;
        }
    };
});
function onThumbnailLoad() {/****/}

